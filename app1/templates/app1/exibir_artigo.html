{% extends "app1/base.html" %}
{% load static %}

{% block content %}
<div class="article-shell">
    {% if mensagem %}
    <div class="inline-alert">
        {{ mensagem }}
    </div>
    {% endif %}
    {% if messages %}
    <div class="toast-stack">
        {% for message in messages %}
        <div class="banner-engajamento show">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    {% if flag %}
    <div class="article-flag">
        <a href="{% url 'newsletter' %}" class="chip-link">Assine nossa newsletter</a>
    </div>
    {% endif %}

    <section class="article-hero">
        <div class="article-header">
            <div class="article-eyebrow">
                <span class="eyebrow-category">{{ artigo.categoria }}</span>
            </div>

            <h1 class="article-title">{{ artigo.titulo }}</h1>

            {% if artigo.resumo %}
            <p class="article-subtitle">{{ artigo.resumo }}</p>
            {% endif %}

            <div class="article-meta-row">
                <div class="author-block">
                    <img src="{% static 'app1/assets/maria.webp' %}" alt="Autor" class="author-avatar">
                    <div class="author-name">
                        Por <span class="author-highlight">Maria Clara Trajano</span>
                    </div>
                </div>
                <div class="article-actions-icons">
                    {% if user.is_authenticated %}
                    <form action="{% url 'favoritar_artigo' artigo.id %}" method="POST" class="icon-btn fav-form {% if user in artigo.favoritos.all %}active{% endif %}">
                        {% csrf_token %}
                        <button type="submit" aria-label="{% if user in artigo.favoritos.all %}Remover dos salvos{% else %}Salvar notícia{% endif %}">
                            {% if user in artigo.favoritos.all %}
                            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                <path d="M8 3h8a1 1 0 0 1 1 1v15.56a.25.25 0 0 1-.39.2L12 16.73l-4.61 3.03a.25.25 0 0 1-.39-.2V4a1 1 0 0 1 1-1Z" fill="currentColor"/>
                            </svg>
                            {% else %}
                            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                <path d="M7.75 3.5h8.5A1.25 1.25 0 0 1 17.5 4.75v14.19a.25.25 0 0 1-.39.2L12 15.62l-5.11 3.52a.25.25 0 0 1-.39-.2V4.75A1.25 1.25 0 0 1 7.75 3.5Z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
                            </svg>
                            {% endif %}
                        </button>
                    </form>
                    {% else %}
                    <a href="{% url 'login' %}" class="icon-btn" aria-label="Fazer login para salvar">
                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <path d="M7.75 3.5h8.5A1.25 1.25 0 0 1 17.5 4.75v14.19a.25.25 0 0 1-.39.2L12 15.62l-5.11 3.52a.25.25 0 0 1-.39-.2V4.75A1.25 1.25 0 0 1 7.75 3.5Z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
                        </svg>
                    </a>
                    {% endif %}
                    <a href="#" class="icon-btn share-btn" aria-label="Compartilhar esta notícia">
                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <path d="M15 7.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Zm0 0-6 3.5m0 0a2.5 2.5 0 1 0-3 2.298 2.5 2.5 0 0 0 3-2.299Zm0 0 6 3.5m0 0a2.5 2.5 0 1 0 2.5 2.5 2.5 2.5 0 0 0-2.5-2.5Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </a>
                </div>
            </div>

            {% if artigo.data_publicacao %}
            <div class="article-pubinfo">
                Publicado em {{ artigo.data_publicacao|date:"d/m/Y 'às' H\\hi" }}
            </div>
            {% endif %}
        </div>

        {% if artigo.imagem %}
        <div class="hero-media">
            <img src="{{ artigo.imagem }}" alt="{{ artigo.titulo }}">
        </div>
        {% endif %}
    </section>

    <section class="article-body">
        <div class="audio-chip">
            <span class="audio-label"><i class="fa-solid fa-play"></i> Escute a matéria</span>
            <audio controls>
                <source src="{% url 'artigo_audio' artigo.id %}" type="audio/mpeg">
                Seu navegador não suporta áudio.
            </audio>
        </div>

        <div class="article-text">
            {{ artigo.conteudo|safe }}
        </div>

        <div class="article-links">
            <a class="chip-link" href="{% url 'sugestao' artigo.id %}">Sugestões de leitura</a>
            <a class="chip-link" href="{% url 'bullets' artigo.id %}">Pontos chave</a>
            <a class="chip-link" href="{% url 'conteudo_de_contexto' artigo.id %}">Conteúdo de contexto</a>
        </div>
    </section>

    <section class="comments-section">
        <div class="comments-card">
            <div class="comments-header">
                <h3>Comentários</h3>
                <span class="comments-count">{{ comentarios|length }}</span>
            </div>
            <form method="POST" class="comment-form">
                {% csrf_token %}
                <div class="comment-inputs">
                    <img src="{% static 'app1/assets/avatar.png' %}" alt="Avatar padrão" class="comment-avatar">
                    <div class="comment-fields">
                        <input type="text" name="nome" placeholder="Seu nome (opcional)">
                        <textarea name="comentario" rows="3" placeholder="Adicione seu comentário..."></textarea>
                        <button type="submit" class="cta ghost">Publicar</button>
                    </div>
                </div>
            </form>

            {% if comentarios %}
            <div class="comments-list">
                {% for item in comentarios %}
                <article class="comment">
                    <div class="comment-avatar-wrap">
                        {% if item.avatar %}
                        <img src="{{ item.avatar }}" alt="{{ item.nome }}" class="comment-avatar">
                        {% else %}
                        <img src="{% static 'app1/assets/avatar.png' %}" alt="{{ item.nome }}" class="comment-avatar">
                        {% endif %}
                    </div>
                    <div class="comment-body">
                        <div class="comment-top">
                            <div class="comment-meta">
                                <span class="comment-author">{{ item.nome }}</span>
                                <span class="comment-date">{{ item.created_at|date:"d/m/Y H\\hi" }}</span>
                            </div>
                            <div class="comment-actions">
                                <i class="fa-regular fa-heart"></i>
                                <span class="comment-reply">Responder</span>
                            </div>
                        </div>
                        <p class="comment-text">{{ item.texto }}</p>
                    </div>
                </article>
                {% endfor %}
            </div>
            {% else %}
            <p class="comment-empty">Seja o primeiro a comentar.</p>
            {% endif %}
        </div>
    </section>

    {% if relacionados %}
    <section class="related-section">
        <h3 class="section-heading">Leia também</h3>
        <div class="related-list">
            {% for rel in relacionados %}
            <article class="related-card">
                {% if rel.imagem %}
                <img class="related-photo" src="{{ rel.imagem }}" alt="{{ rel.titulo }}">
                {% endif %}
                <div class="related-overlay">
                    <span class="card-category light">{{ rel.categoria|upper }}</span>
                    <h4><a href="{% url 'exibir_artigo' rel.id %}">{{ rel.titulo }}</a></h4>
                </div>
            </article>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const banner = document.getElementById("banner");
        if (banner) {
            setTimeout(() => {
                banner.classList.add("show");
            }, 200);
            setTimeout(() => {
                banner.classList.remove("show");
            }, 5200);
        }
    });
</script>
{% endblock content %}
